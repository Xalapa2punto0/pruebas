<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lector de QR â€“ Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #111;
    color: #fff;
  }
  #reader {
    width: 300px;
    margin: 20px auto;
  }
  .ok {
    color: #00ff88;
    font-weight: bold;
  }
  .error {
    color: #ff5555;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>ðŸ“· Registro de Asistencia</h2>
<p>Escanea el QR del gafete</p>

<div id="reader"></div>
<p id="resultado"></p>

<!-- Lector QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ðŸ”‘ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDqyTJMHpPVeoQuV1xFFPWPCxkZpaQiGv0",
  authDomain: "proyecto-asistencia-4b6ba.firebaseapp.com",
  projectId: "proyecto-asistencia-4b6ba",
  storageBucket: "proyecto-asistencia-4b6ba.firebasestorage.app",
  messagingSenderId: "185333223533",
  appId: "1:185333223533:web:fcf2472f517c4a6dfdaf64"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const resultado = document.getElementById("resultado");

/* ðŸ“¸ Inicializar lector QR */
const qr = new Html5Qrcode("reader");

qr.start(
  { facingMode: "environment" },
  {
    fps: 10,
    qrbox: 250
  },
  async (decodedText) => {
    qr.pause(); // â›” evitar mÃºltiples lecturas

    try {
      const ref = doc(db, "usuarios", decodedText);
      await updateDoc(ref, {
        asistencia: true,
        fechaAsistencia: new Date()
      });

      resultado.innerHTML = `âœ… Asistencia registrada<br>ID: ${decodedText}`;
      resultado.className = "ok";
    } catch (e) {
      resultado.innerHTML = "âŒ Error al registrar asistencia";
      resultado.className = "error";
    }

    setTimeout(() => {
      resultado.innerHTML = "";
      qr.resume();
    }, 2000);
  }
);

</script>

</body>
</html>
