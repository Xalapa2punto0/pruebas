<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lector de QR â€“ Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    text-align: center;
    background: #000;
    color: #fff;
    margin: 0;
    padding: 0;
  }

  h2 {
    margin-top: 14px;
  }

  #reader {
    width: 100vw;
    height: 70vh;
    margin: 0 auto;
    overflow: hidden;
  }

  #resultado {
    margin-top: 12px;
    font-size: 1.1rem;
    min-height: 40px;
  }

  .ok {
    color: #00ff88;
    font-weight: bold;
  }

  .error {
    color: #ff5555;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>ðŸ“· Registro de Asistencia</h2>
<p>Coloca el QR dentro del recuadro</p>

<div id="reader"></div>
<div id="resultado"></div>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ðŸ”‘ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDqyTJMHpPVeoQuV1xFFPWPCxkZpaQiGv0",
  authDomain: "proyecto-asistencia-4b6ba.firebaseapp.com",
  projectId: "proyecto-asistencia-4b6ba",
  storageBucket: "proyecto-asistencia-4b6ba.firebasestorage.app",
  messagingSenderId: "185333223533",
  appId: "1:185333223533:web:fcf2472f517c4a6dfdaf64"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const resultado = document.getElementById("resultado");

let ultimoQR = null;
let bloqueo = false;

/* ðŸ“¸ Inicializar lector */
const qr = new Html5Qrcode("reader");

qr.start(
  { facingMode: "environment" },
  {
    fps: 15,
    qrbox: { width: 300, height: 300 },
    aspectRatio: 1.0,
    disableFlip: false
  },
  async (decodedText) => {
    if (bloqueo) return;

    // Evitar mÃºltiples lecturas del mismo QR
    if (decodedText === ultimoQR) return;

    bloqueo = true;
    ultimoQR = decodedText;

    try {
      const ref = doc(db, "usuarios", decodedText);
      await updateDoc(ref, {
        asistencia: true,
        fechaAsistencia: serverTimestamp()
      });

      resultado.textContent = "âœ… Asistencia registrada";
      resultado.className = "ok";
    } catch (e) {
      console.error(e);
      resultado.textContent = "âŒ Error al registrar asistencia";
      resultado.className = "error";
    }

    // Liberar lectura despuÃ©s de 1.5s
    setTimeout(() => {
      resultado.textContent = "";
      bloqueo = false;
    }, 1500);
  },
  (error) => {
    // Silenciar errores de frame (normal)
  }
);

/* ðŸ§  iOS Fix: reintento si Safari bloquea cÃ¡mara */
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    qr.resume?.();
  }
});
</script>

</body>
</html>
