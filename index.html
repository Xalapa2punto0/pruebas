<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistencia QR</title>

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system;
    text-align: center;
  }

  h2 { margin: 10px 0 4px; }
  p { margin: 0 0 10px; opacity: .8; }

  #reader {
    width: 100vw;
    height: 75vh;
  }

  #status {
    height: 42px;
    font-size: 1.2rem;
  }

  .ok { color: #00ff88; }
  .error { color: #ff5555; }
</style>
</head>
<body>

<h2>ðŸ“· Registro de Asistencia</h2>
<p>Escanea el QR del gafete</p>

<div id="reader"></div>
<div id="status"></div>

<!-- Firebase compat (mÃ¡s estable en Safari) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyDqyTJMHpPVeoQuV1xFFPWPCxkZpaQiGv0",
    authDomain: "proyecto-asistencia-4b6ba.firebaseapp.com",
    projectId: "proyecto-asistencia-4b6ba"
  });

  const db = firebase.firestore();
  const status = document.getElementById("status");

  let bloqueado = false;

  const qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 260 },
    async (id) => {
      if (bloqueado) return;
      bloqueado = true;

      try {
        await db.collection("usuarios").doc(id).update({
          asistencia: true,
          fechaAsistencia: firebase.firestore.FieldValue.serverTimestamp()
        });

        status.textContent = "âœ… Asistencia registrada";
        status.className = "ok";
        navigator.vibrate?.(100);
      } catch (e) {
        status.textContent = "âŒ QR no vÃ¡lido";
        status.className = "error";
      }

      setTimeout(() => {
        status.textContent = "";
        bloqueado = false;
      }, 1500);
    }
  );
</script>

</body>
</html>
